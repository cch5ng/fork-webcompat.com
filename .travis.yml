# Need to use "trusty" for Java 1.8
# ref: https://blog.travis-ci.com/2015-10-14-opening-up-ubuntu-trusty-beta/
sudo: required
dist: trusty

language: python

python:
  - "2.7"

# cache pip and npm package installations
cache:
  pip: true
  directories:
    - node_modules

# limit the depth of the commits we clone
git:
  depth: 5

env:
  global:
    - ISSUES_REPO_URI=webcompat/webcompat-tests/issues
    - FAKE_ID=e80a666fbf1fa9ea18db
    - FAKE_SECRET=688c4546f09624f8c44773b22268064dfca19a59
    # grab latest 4.x release, which is LTS for now
    - TRAVIS_NODE_VERSION="4"
    - BROWSERSTACK_USERNAME:
      secure: "ijBiVkRhLhcy+MfA/LTx15ZPsc9h7DQiHOv6Mosv9/Wq4heG6Fsn46+U5uli8u/eIJVWxr5l/VvkrAHLLyrTDHMPYui89isht6WQGKItZHuE3jdeygDaxP0RysmXWQ42d1yn0tjzcEVY3E9xQgObXGPmc1Mbm0GQ0GhR4zyFSOToUPV3Qy+vf8+th+zrPFM5+2xZVSaO6XrhjC9vXpDu9baV+Ls0pN6vkFvD0JavuJohXfDxdZbDvPLQcBt/emp9Yhd8YRXGDGp+jbNC87lo69nxPIijufeUEaccTGXcGcwWZ43RXT/LPwm5ryAsjPMu2xU5IQg0csVr3z8rEBH5Ls0d8/DkY1VHDFEV448wgas3mdzj/sS5fSChkfrTp53w1xuOjKbhGL67BRxlfzl21lP8wrm9alGgOa6j0uEepHHrEekBWF5VvV8x1WX8eIu4AGJCI45pOV8nG1ueellVyfFOcXw+y4LfhllLAFhTKTsBvKQqT1EfY2ZU+4GJYOvTuPsojYmiRPfYw9viaDXawGWvGvOyZKY4DHq6iSOr537IzNAP99kmsCz4k2LMAQJNOjF+EdCZLRuK/TxTWSx11oHkpTFY7bw3VlbtEpioliUVyrcrCG+GqILLVmInrQdWyW0ExlWyQXDMX6Ae1rK6eyCSixv061wkVm8DbQSxlBM="
    - BROWSERSTACK_ACCESS_KEY:
      secure: "HS5ezC1F3rjlq1ZzxnuvzuZqDKz1cLQ7N6R99YgkF+uJb6xq+BQAp+cTW5LvexEJmhbyy1Q3IXIe+Vo/YxVGOVlWLtLXJlhz2+vAVharB3GCtiP4Ub9nDHhk2ztYfLMjaJPbUC3bGODqAncobRAf76jPaybNQhWrRb2HWb2rZlZmr+n3y+YTDelUXrXcpwhp+SpSHAjrQdeWk5aho6RYVGHzO/oeaD5nlBqopedr6SHchFNIOa5/8ljOQjvUeaSgIyJFQn79w6cYQwbcOsAjeLx3YMan6cPqFO727qVOBGxL0OJnsQGZKwsrtDv7G5akt2NRsemw5HJtQuGIIYrr+qdiY+7qyAvN3lot28As3V7+lglmrbO4wV3138b9zWZxHOfmkP6tvZfZjSWhmj1SDbfXlsT7VBG5G6Wz1NA4KGDlsDbqbVIKWM/Qtf8LZNGgGn4hbNKKo6eVVzBo1ArIB/RZrmgIlb/T3xRkraYFuWje/2fFLrvo6EQgCBsZZ7dTw2tOvtd28/v9AsxCuDH4/Pc1Lc+nlVslCZ079FMJljeCJuhllE65Dl3hiHHHbWb+1eGIPXzUiAIsO89w+Gjojuqd2OGQr7bLrfdP723ihbGaAUbQrCweoSRgIKnzuXebJn5H6BkFvKM4NM2EdiQYkMLv3nFI71rXEvrINOKdUBQ="

addons:
  firefox: "50.1.0"
  browserstack:
    username: BROWSERSTACK_USERNAME
    access_key: BROWSERSTACK_ACCESS_KEY
    forcelocal: true
    #only: localhost,5000,0
    proxyHost: "http://localhost"
    proxyPort: "5000"

before_install:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"

install:
  - rm -rf ~/.nvm && git clone https://github.com/creationix/nvm.git ~/.nvm && (cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`) && source ~/.nvm/nvm.sh && nvm install $TRAVIS_NODE_VERSION
  - travis_retry npm install -g grunt-cli
  - travis_retry npm install
  - travis_retry npm run pip
  - travis_retry npm run config
  - which firefox
  - java -version
  - firefox --version
  # lint python
  - pep8 --ignore=E402 webcompat/ tests/ config/secrets.py.example
  - npm run module
  - python run.py -t &

before_script:
  - "sleep 2"
  # lint JS in default eslint task
  - npm run lint
  - npm run build

# now run the tests!
# if this is a pull request from a fork, TRAVIS_SECURE_ENV_VARS will be false, so
# just run the non-auth tests. otherwise, run everything.
script:
  - nosetests
  - if [ "$TRAVIS_SECURE_ENV_VARS" == "false" ] ; then node_modules/.bin/intern-runner BROWSERSTACK_USERNAME=$BROWSERSTACK_USERNAME BROWSERSTACK_ACCESS_KEY=$BROWSERSTACK_ACCESS_KEY config=tests/browserstack_remote BROWSERSTACK_USERNAME="$BROWSERSTACK_USERNAME" BROWSERSTACK_ACCESS_KEY="$BROWSERSTACK_ACCESS_KEY" reporters=Console functionalSuites=tests/functional-nonauth ; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" == "true" ] ; then node_modules/.bin/intern-runner config=tests/intern reporters=Console user="$USER" pw="$PW" ; fi
